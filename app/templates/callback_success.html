{% extends "base.html" %}

{% block content %}
<div class="max-w-lg mx-auto text-center space-y-4">
    <h1 class="text-2xl font-semibold">Setting up your secure sessionâ€¦</h1>
    <p class="text-zinc-400">We are saving your Tesla tokens locally so only your browser can reuse them. This page will redirect once everything is ready.</p>
    <div class="animate-pulse text-sm text-zinc-500">Please keep this tab open.</div>
</div>
<script type="module">
import { saveBundle, loadBundle } from '/static/js/token-storage.js';
import { registerServiceWorker } from '/static/js/sw-register.js';

const tokens = {{ tokens | tojson }};

async function bootstrap() {
    try {
        // Save tokens to IndexedDB
        await saveBundle(tokens);

        // Register and wait for service worker
        await registerServiceWorker();

        // Wait for service worker to be ready and controlling
        if ('serviceWorker' in navigator) {
            await navigator.serviceWorker.ready;

            // If no controller yet, wait for it
            if (!navigator.serviceWorker.controller) {
                await new Promise((resolve) => {
                    navigator.serviceWorker.addEventListener('controllerchange', resolve, { once: true });
                });
            }
        }

        // Verify tokens were saved correctly
        const savedBundle = await loadBundle();
        if (!savedBundle) {
            throw new Error('Tokens were not saved to IndexedDB');
        }

        // Navigate to dashboard
        window.location.replace('/?refreshed=1');
    } catch (error) {
        console.error('Unable to persist Tesla tokens', error);
        const msg = document.createElement('p');
        msg.className = 'text-red-400 text-sm mt-4';
        msg.textContent = 'Something went wrong while saving your session. Please try logging in again.';
        document.querySelector('div.max-w-lg').appendChild(msg);
    }
}

bootstrap();
</script>
{% endblock %}
